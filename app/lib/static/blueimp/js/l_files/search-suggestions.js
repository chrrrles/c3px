function searchSuggestions(){if(!(CL.browser.ieVersion<=7)){$('form').submit(function(){if(catAbb&&($('#catAbb').val()===catAbb)){$('#catAbb').attr('disabled','disabled');}
normalizeSearchField($('#query'));storeSearchTerm($('#query').val());});function gatherSuggestions(request,response){var term=$.trim(request.term);var terms=term.toLowerCase().split(' ');var suggestions=[];var remotePromise=$.getJSON('/suggest-search',{v:"3",cat:$("#catAbb").val(),term:request.term});$.each($.totalStorage('searchTerms')||[],function(i,historyItem){var matchedAll=true;$.each(terms,function(i,term){var m=new RegExp($.ui.autocomplete.escapeRegex(term),"i");if(!historyItem.match(m)){matchedAll=false;}});if(matchedAll){suggestions.push({type:'local',val:historyItem});}});remotePromise.done(function(data){$.each(data,function(i,item){if($.inArray(item,suggestions)===-1){suggestions.push({type:'remote',val:item});}});suggestions=$.map(suggestions,function(item){var label=item.val;$.each(terms,function(i,term){var m=new RegExp("\\b("+$.ui.autocomplete.escapeRegex(term)+")","i");label=label.replace(m,"<b>$1</b>");})
if(item.type==='local'){label='<span class="local">'+label+'</span><span class="remove">Remove</span>';}
return{label:label,value:item.val};});response(suggestions);});}
if(canUseSuggestions()){$("#query").autocomplete({source:gatherSuggestions,minLength:1,delay:100,select:function(e,ui){if(ui.item.value){var targetChain=e;while(targetChain.originalEvent!==undefined){targetChain=targetChain.originalEvent;}
var $realtarget=$(targetChain.target||targetChain.srcElement);if($realtarget.is('span.remove')){e.preventDefault();removeSearchTerm(ui.item.value);}}}})
.each(function(){$(this).data('autocomplete')._renderItem=function(ul,item){return $("<li>").data("item.autocomplete",item)
.append("<a>"+item.label+"</a>").appendTo(ul);};});}}}
$(document).ready(function(){searchSuggestions();});function canUseSuggestions(){var C=document.cookie.split(';');for(i=0;i<C.length;i++){var c=$.trim(C[i]);if(c.indexOf('cl_b=')===0)return true;}
return false;}
function storeSearchTerm(term){var searchTerms=$.totalStorage('searchTerms')||[];if($.inArray(term,searchTerms)===-1){searchTerms.push(term);$.totalStorage('searchTerms',searchTerms);}}
function removeSearchTerm(term){var searchTerms=$.totalStorage('searchTerms')||[];if(searchTerms){searchTerms=$.grep(searchTerms,function(thisterm){return!(thisterm===term);});$.totalStorage('searchTerms',searchTerms);}}
function normalizeSearchField($input){var raw=$input.val();$input.val($.trim(raw).replace(/\s+/g,' ').toLowerCase());}